<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>kCERT</title>
    
    <!-- Office.js -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Fabric UI CSS -->
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-js/1.4.0/css/fabric.min.css">
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-js/1.4.0/css/fabric.components.min.css">
</head>

<body class="ms-Fabric">
    <div class="ms-welcome">
        <header class="ms-welcome__header">
            <div class="branding">
                <img src="assets/KPMG_blue_logo.svg.png" alt="KPMG" class="brand-logo" />
                <div class="brand-text">
                    <h1>kCERT</h1>
                    <p>KPMG Comprehensive Excel Review Tool</p>
                </div>
            </div>
        </header>
        
        <main class="ms-welcome__main">
            <section class="analysis-shell">
                <div class="analysis-tabs" role="tablist">
                    <button class="analysis-tab" id="analysisTab_summary" data-target="summaryView" aria-selected="true" role="tab">Summary</button>
                    <button class="analysis-tab" id="analysisTab_listing" data-target="listingView" aria-selected="false" role="tab">Unique Formula Listing</button>
                    <button class="analysis-tab" id="analysisTab_maps" data-target="mapsView" aria-selected="false" role="tab">Maps</button>
                    <button class="analysis-tab" id="analysisTab_color" data-target="colorView" aria-selected="false" role="tab">Color Unique / Inputs</button>
                </div>
                <div class="analysis-toolbar" id="analysisToolbar">
                    <div class="toolbar-section" id="scopeControl" data-view="summaryView,listingView,mapsView,colorView">
                        <label for="analysisScope">Scope</label>
                        <select id="analysisScope">
                            <option value="workbook" selected>Entire workbook</option>
                            <option value="sheet">Specific sheets…</option>
                        </select>
                        <div id="sheetScopePicker" class="sheet-scope-picker" hidden>
                            <div id="sheetScopeList" class="sheet-scope-list"></div>
                        </div>
                    </div>
                    <div class="toolbar-section" id="summaryToolbar" data-view="summaryView" hidden>
                        <label for="minutesPerFormula">Minutes / formula</label>
                        <input type="number" id="minutesPerFormula" min="0.1" step="0.1" value="2">
                        <span class="toolbar-note">Adjust estimate based on reviewer skill & model complexity.</span>
                    </div>
                    <div class="toolbar-section" id="gptSettingsToolbar" data-view="summaryView,listingView" hidden>
                        <button class="ms-Button toolbar-button" id="gptSettings" type="button"><span class="ms-Button-label">GPT Settings</span></button>
                    </div>
                    <div class="toolbar-section" id="listingToolbar" data-view="listingView" hidden>
                        <label class="toolbar-checkbox"><input type="checkbox" id="listingReviewedFilter"> Reviewed only</label>
                        <input type="search" id="listingSearch" placeholder="Search formulas or UFIs">
                        <button class="ms-Button toolbar-button" id="exportListing" type="button"><span class="ms-Button-label">Export UFL to sheet</span></button>
                    </div>
                    <div class="toolbar-section" id="mapsToolbar" data-view="mapsView" hidden>
                        <button class="ms-Button toolbar-button" id="toggleMapLegend" type="button"><span class="ms-Button-label">Legend</span></button>
                        <button class="ms-Button toolbar-button" id="mapsExport" type="button"><span class="ms-Button-label">Export map index</span></button>
                    </div>
                    <div class="toolbar-section" id="colorToolbar" data-view="colorView" hidden>
                        <button class="ms-Button toolbar-button" id="applyColorUnique" type="button"><span class="ms-Button-label">Apply Colors</span></button>
                        <button class="ms-Button toolbar-button" id="removeModelColors" type="button"><span class="ms-Button-label">Reset Colors</span></button>
                    </div>
                </div>

                <div id="summaryView" class="analysis-view" role="tabpanel" aria-labelledby="analysisTab_summary">
                    <section class="ms-welcome__features">
                        <div class="ms-Grid">
                            <div class="ms-Grid-row">
                                <div class="ms-Grid-col ms-sm12">
                                    <div class="ms-TextField">
                                        <label class="ms-Label">Analysis Options</label>
                                        <div class="analysis-options">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="includeEmptyCells" checked>
                                                <label for="includeEmptyCells">Include empty cells in analysis</label>
                                            </div>
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="groupSimilarFormulas" checked>
                                                <label for="groupSimilarFormulas">Group similar formulas</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="ms-Grid">
                            <div class="ms-Grid-row">
                                <div class="ms-Grid-col ms-sm12">
                                    <button id="analyzeFormulas" class="ms-Button ms-Button--primary">
                                        <span class="ms-Button-label">Analyze Workbook Formulas</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="summaryOverview" class="summary-overview" hidden>
                        <h3 class="section-title">
                            Estimated Review Time
                            <span class="help-icon" data-tooltip="Estimated time required to review all unique formulas. Adjust the minutes-per-formula setting above based on reviewer experience and model complexity.">?</span>
                        </h3>
                        <p class="section-help">Use this overview to gauge the estimated time required for review. Adjust the minutes-per-formula control above to reflect reviewer experience and model complexity.</p>
                        <div class="summary-budget-grid">
                            <div class="summary-budget-card">
                                <span class="summary-budget-number" id="summaryUniqueCount">0</span>
                                <span class="summary-budget-label">Unique formulas</span>
                            </div>
                            <div class="summary-budget-card">
                                <span class="summary-budget-number" id="summaryEstimatedMinutes">0</span>
                                <span class="summary-budget-label">Estimated minutes</span>
                            </div>
                            <div class="summary-budget-card">
                                <span class="summary-budget-number" id="summaryEstimatedHours">0</span>
                                <span class="summary-budget-label">Estimated hours</span>
                            </div>
                            <div class="summary-budget-card">
                                <span class="summary-budget-number" id="summaryWorksheetsScanned">0</span>
                                <span class="summary-budget-label">Worksheets analysed</span>
                            </div>
                        </div>
                    </section>

                    <section id="workbookStats" class="workbook-stats-section" hidden>
                        <div class="workbook-stats-header">
                            <h3 class="section-title">Workbook Overview</h3>
                            <button class="ms-Button ms-Button--primary ask-gpt-workbook-button" id="askGptWorkbook" type="button">
                                <span class="ms-Button-label">Ask GPT: Explain Workbook</span>
                            </button>
                        </div>
                        <p class="section-help">Comprehensive statistics for the entire workbook.</p>
                        
                        <div class="stats-grid">
                            <div class="stats-group">
                                <h4 class="stats-group-title">
                                    Formulas
                                    <span class="help-icon" data-tooltip="Formula statistics across the entire workbook.">?</span>
                                </h4>
                                <div class="stats-grid-inner">
                                    <div class="stat-card">
                                        <span class="stat-number" id="wbTotalFormulas">0</span>
                                        <span class="stat-label">Total Formulas</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number" id="wbUniqueFormulas">0</span>
                                        <span class="stat-label">Unique Formulas</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number" id="wbAvgFormulasPerSheet">0</span>
                                        <span class="stat-label">Avg per Sheet</span>
                                    </div>
                                </div>
                            </div>

                            <div class="stats-group">
                                <h4 class="stats-group-title">
                                    Complexity Distribution
                                    <span class="help-icon" data-tooltip="Number of worksheets categorized by their overall formula complexity level (High, Medium, or Low).">?</span>
                                </h4>
                                <div class="stats-grid-inner">
                                    <div class="stat-card">
                                        <span class="stat-number" id="wbComplexityHigh">0</span>
                                        <span class="stat-label">High</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number" id="wbComplexityMedium">0</span>
                                        <span class="stat-label">Medium</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number" id="wbComplexityLow">0</span>
                                        <span class="stat-label">Low</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="sheetBreakdown" class="sheet-breakdown-section" hidden>
                        <h3 class="section-title">
                            Sheet-by-Sheet Breakdown
                            <span class="help-icon" data-tooltip="Detailed statistics for each worksheet showing formulas, unique formulas, cell counts, formula density, hard-coded values, and complexity level.">?</span>
                        </h3>
                        <p class="section-help">Detailed statistics for each worksheet in the workbook.</p>
                        <div id="sheetBreakdownContent" class="sheet-breakdown-content"></div>
                    </section>

                    <section id="resultsSection" class="results-section" style="display: none;">
                        <h3 class="ms-fontSize-l ms-fontWeight-semibold">Analysis Results</h3>
                        <!-- existing content -->
                    </section>
                </div>

                <div id="listingView" class="analysis-view" role="tabpanel" aria-labelledby="analysisTab_listing" hidden>
                    <section class="listing-header">
                        <h3 class="section-title">Unique Formula Listing (UFL)</h3>
                        <p class="section-help">Review each unique formula, prioritise by Formula Score (F-Score), and capture FIN references directly within the table.</p>
                    </section>
                    <section class="listing-table-shell">
                        <div class="listing-scroll">
                            <table id="uniqueFormulaTable">
                                <colgroup id="tableColgroup">
                                    <!-- Column widths will be set dynamically -->
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th data-sortable="false">UFI</th>
                                        <th data-sortable="false">FIN</th>
                                        <th data-sortable="true" data-sort-key="sheet">Sheet</th>
                                        <th data-sortable="false">Formula</th>
                                        <th data-sortable="false">Formula (normalized)</th>
                                        <th data-sortable="true" data-sort-key="count" class="sortable-header">Count</th>
                                        <th data-sortable="true" data-sort-key="complexity" class="sortable-header">Complexity / F-Score<span class="help-icon" data-tooltip="Complexity band (Low/Medium/High) derived from F-Score thresholds: Low (0-29), Medium (30-59), High (60-99). F-Score = weighted function complexity + structure (depth/operators/arrays) + usage. Heuristic scoring system.">?</span></th>
                                        <th data-sortable="false">Priority</th>
                                        <th data-sortable="false">Status</th>
                                        <th data-sortable="false">Comment</th>
                                        <th data-sortable="false">Client Response</th>
                                        <th data-sortable="false">Ask GPT</th>
                                    </tr>
                                </thead>
                                <tbody id="uniqueFormulaTableBody"></tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <div id="mapsView" class="analysis-view" role="tabpanel" aria-labelledby="analysisTab_maps" hidden>
                    <!-- existing map controls moved here -->
                    <div class="map-controls">
                        <div class="map-actions">
                            <button id="generateMaps" class="ms-Button">
                                <span class="ms-Button-label">Generate Worksheet Maps</span>
                            </button>
                            <button id="refreshMapSheets" class="ms-Button map-refresh-button" type="button">
                                <span class="ms-Button-label">Refresh List</span>
                            </button>
                        </div>
                        <div class="map-selection">
                            <label class="map-selection-label">Select worksheets to include</label>
                            <div class="map-selection-actions">
                                <button id="selectAllMapSheets" class="ms-Button map-mini-button" type="button">
                                    <span class="ms-Button-label">Select All</span>
                                </button>
                                <button id="clearAllMapSheets" class="ms-Button map-mini-button" type="button">
                                    <span class="ms-Button-label">Deselect All</span>
                                </button>
                            </div>
                            <div id="mapSheetChecklist" class="map-sheet-list">
                                <div class="map-sheet-placeholder">Loading worksheets...</div>
                            </div>
                        </div>
                        <div id="mapRunSummary" class="map-run-summary" style="display: none;"></div>
                        <div class="map-legend" id="mapLegendPanel">
                            <h5>Worksheet Map Legend</h5>
                            <ul>
                                <li><span class="map-symbol map-symbol-f">F</span> Unique formula</li>
                                <li><span class="map-symbol map-symbol-left">&lt;</span> Copy from the left</li>
                                <li><span class="map-symbol map-symbol-up">^</span> Copy from above</li>
                                <li><span class="map-symbol map-symbol-both">+</span> Copy from both left and above</li>
                                <li><span class="map-symbol map-symbol-label">L</span> Label / descriptive text</li>
                                <li><span class="map-symbol map-symbol-input">N</span> Numeric input</li>
                                <li><span class="map-symbol map-symbol-array">A</span> Array formula spill</li>
                            </ul>
                            <p class="map-legend-note">Maps highlight copy direction breaks and blank cells within copy runs in the task pane summary after generation.</p>
                        </div>
                    </div>
                </div>

                <div id="colorView" class="analysis-view" role="tabpanel" aria-labelledby="analysisTab_color" hidden>
                    <section class="color-controls">
                        <h3 class="section-title">Color Unique Formulae and Inputs</h3>
                        <p class="section-help">Apply purple for unique formulas and yellow for numeric inputs across the selected scope. Reset colors to strip model formatting before reapplying MRT colors.</p>
                        <div class="color-actions">
                            <button class="ms-Button" id="colorApply" type="button"><span class="ms-Button-label">Color Unique</span></button>
                            <button class="ms-Button" id="colorReset" type="button"><span class="ms-Button-label">Remove Model Colors</span></button>
                        </div>
                        <div class="color-options">
                            <label class="checkbox-container">
                                <input type="checkbox" id="colorResetFills" checked>
                                <span>Reset fills to "No Fill"</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" id="colorResetFont" checked>
                                <span>Reset font color to "Automatic"</span>
                            </label>
                        </div>
                    </section>
                </div>
            </section>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="ms-Spinner ms-Spinner--large">
                    <div class="ms-Spinner-circle"></div>
                    <div class="ms-Spinner-label">Analyzing formulas...</div>
                </div>
            </div>

            <!-- GPT Settings Modal -->
            <div id="gptSettingsModal" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>GPT Settings</h3>
                        <button class="modal-close" id="closeGptSettings">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-field">
                            <label for="bearerToken">Bearer Token</label>
                            <input type="password" id="bearerToken" placeholder="Enter bearer token" />
                        </div>
                        <div class="form-field">
                            <label for="engagementCode">Engagement Code</label>
                            <input type="text" id="engagementCode" placeholder="Enter engagement code" />
                        </div>
                        <div id="gptSettingsStatus" class="settings-status"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="ms-Button ms-Button--primary" id="saveGptSettings">Save & Validate</button>
                        <button class="ms-Button" id="cancelGptSettings">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- GPT Response Modal -->
            <div id="gptResponseModal" class="modal-overlay" style="display: none;">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h3>Formula Explanation</h3>
                        <button class="modal-close" id="closeGptResponse">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="gptResponseContent" class="gpt-response-content"></div>
                        <div id="gptResponseError" class="gpt-response-error" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="ms-Button" id="closeGptResponseBtn">Close</button>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessages" class="status-messages"></div>
        </main>
    </div>
</body>
</html> 
